<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AICENGHUB Admin</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: rgba(15, 28, 53, 0.85);
      --ink: #ecf6ff;
      --muted: #9eb9cf;
      --accent: #2ec5d4;
      --accent-2: #f4b73f;
      --danger: #f98585;
    }

    * { box-sizing: border-box; }

    [hidden] { display: none !important; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background:
        radial-gradient(1200px 560px at 18% -10%, rgba(46, 197, 212, 0.18), transparent 62%),
        radial-gradient(900px 480px at 88% 110%, rgba(244, 183, 63, 0.15), transparent 58%),
        var(--bg);
      color: var(--ink);
      display: grid;
      place-items: center;
      padding: 1.2rem;
    }

    .card {
      width: min(620px, 100%);
      border-radius: 14px;
      border: 1px solid rgba(46, 197, 212, 0.35);
      background: var(--panel);
      padding: 1rem;
      box-shadow: 0 10px 36px rgba(0, 0, 0, 0.34);
    }

    h1 {
      margin: 0 0 0.5rem;
      font-size: 1.2rem;
    }

    p {
      margin: 0;
      color: var(--muted);
      line-height: 1.45;
    }

    .auth-panel {
      margin-top: 0.95rem;
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-radius: 12px;
      padding: 0.8rem;
      background: rgba(3, 8, 18, 0.55);
      display: grid;
      gap: 0.7rem;
    }

    .auth-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.6rem;
    }

    .logout-btn {
      font: inherit;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      padding: 0.62rem 0.72rem;
      background: rgba(3, 8, 18, 0.72);
      color: var(--ink);
      cursor: pointer;
    }

    .logout-btn:hover {
      filter: brightness(1.08);
    }

    .maintenance-panel {
      margin-top: 0.95rem;
    }

    .actions {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.7rem;
      margin-top: 0.95rem;
    }

    @media (max-width: 560px) {
      .actions {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    button {
      font: inherit;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      padding: 0.62rem 0.72rem;
    }

    .action-btn {
      cursor: pointer;
      font-weight: 700;
      border-color: rgba(244, 183, 63, 0.7);
      background: linear-gradient(180deg, #f7ca6f, #f0a933);
      color: #201105;
      transition: filter 130ms ease, transform 130ms ease, box-shadow 130ms ease;
    }

    .action-btn:not(:disabled):hover {
      filter: brightness(1.06);
      transform: translateY(-1px);
    }

    .action-btn:not(:disabled):active {
      filter: brightness(0.98);
      transform: translateY(0) scale(0.98);
    }

    button:disabled {
      opacity: 0.6;
      cursor: wait;
    }

    .status {
      margin-top: 0.85rem;
      font-size: 0.94rem;
      white-space: pre-wrap;
      line-height: 1.4;
    }

    .status.error {
      color: var(--danger);
    }

    .status.ok {
      color: #b0f6c8;
    }

    .candidate-panel {
      margin-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.16);
      padding-top: 0.9rem;
    }

    .candidate-panel h2 {
      margin: 0;
      font-size: 1rem;
      color: #d6f7ff;
    }

    .candidate-panel p {
      margin-top: 0.35rem;
      font-size: 0.86rem;
    }

    .candidate-list {
      margin-top: 0.7rem;
      max-height: 320px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 0.6rem;
      background: rgba(3, 8, 18, 0.72);
      display: grid;
      gap: 0.55rem;
    }

    .candidate-item {
      border: 1px solid rgba(46, 197, 212, 0.3);
      border-radius: 10px;
      padding: 0.54rem;
      background: rgba(46, 197, 212, 0.08);
      display: grid;
      gap: 0.24rem;
    }

    .candidate-item strong {
      color: #f7edc7;
      font-size: 0.9rem;
      line-height: 1.3;
    }

    .candidate-item a {
      color: #9defff;
      text-decoration: none;
      font-size: 0.82rem;
      word-break: break-all;
    }

    .candidate-item a:hover {
      text-decoration: underline;
    }

    .candidate-meta,
    .auth-status {
      color: var(--muted);
      font-size: 0.82rem;
      line-height: 1.35;
    }

    .auth-status.error {
      color: var(--danger);
    }

    .auth-status.ok {
      color: #b0f6c8;
    }
  </style>
</head>
<body>
  <main class="card">
    <h1>Admin: List Maintenance</h1>
    <p>Sign in with an approved Google account, then use Update List to merge pending candidates and Update Tier to normalize pricing/tags.</p>

    <section class="auth-panel" aria-label="Admin authentication panel">
      <p id="auth-note">Admin authentication is required.</p>
      <div class="auth-row">
        <div id="google-signin-button"></div>
        <button id="logout-btn" class="logout-btn" type="button" hidden>Sign out</button>
      </div>
      <div id="auth-status" class="auth-status" aria-live="polite"></div>
    </section>

    <section id="maintenance-panel" class="maintenance-panel" hidden>
      <div class="actions">
        <button id="update-list-btn" class="action-btn" type="button">Update List</button>
        <button id="update-tier-btn" class="action-btn" type="button">Update Tier</button>
      </div>

      <div id="status" class="status" aria-live="polite"></div>

      <section class="candidate-panel" aria-label="Candidate list panel">
        <h2>Candidate List</h2>
        <p>Scroll to load more pending/merged candidates from database.</p>
        <div id="candidate-list" class="candidate-list" aria-live="polite"></div>
        <div id="candidate-meta" class="candidate-meta"></div>
      </section>
    </section>
  </main>

  <script>
    const updateButton = document.getElementById("update-list-btn");
    const updateTierButton = document.getElementById("update-tier-btn");
    const statusNode = document.getElementById("status");
    const candidateListNode = document.getElementById("candidate-list");
    const candidateMetaNode = document.getElementById("candidate-meta");
    const maintenancePanelNode = document.getElementById("maintenance-panel");
    const authNoteNode = document.getElementById("auth-note");
    const authStatusNode = document.getElementById("auth-status");
    const signInButtonHost = document.getElementById("google-signin-button");
    const logoutButton = document.getElementById("logout-btn");

    const CANDIDATE_PAGE_SIZE = 40;
    const CANDIDATE_SCROLL_THRESHOLD_PX = 120;
    let candidateOffset = 0;
    let candidateHasMore = true;
    let candidateLoading = false;

    const state = {
      authenticated: false,
      user: null,
      googleClientId: "",
      googleReady: false
    };

    function setStatus(message, type) {
      statusNode.textContent = message;
      statusNode.classList.remove("ok", "error");
      if (type) statusNode.classList.add(type);
    }

    function setAuthStatus(message, type) {
      authStatusNode.textContent = message;
      authStatusNode.classList.remove("ok", "error");
      if (type) authStatusNode.classList.add(type);
    }

    function setCandidateMeta(message) {
      candidateMetaNode.textContent = message;
    }

    function formatDate(value) {
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "-";
      return date.toLocaleString();
    }

    function setAuthState(authenticated, user) {
      state.authenticated = Boolean(authenticated);
      state.user = user || null;
      maintenancePanelNode.hidden = !state.authenticated;

      if (state.authenticated) {
        authNoteNode.textContent = `Signed in as ${state.user && state.user.email ? state.user.email : "admin"}.`;
        logoutButton.hidden = false;
        signInButtonHost.hidden = true;
      } else {
        authNoteNode.textContent = "Admin authentication is required.";
        logoutButton.hidden = true;
        signInButtonHost.hidden = false;
        candidateListNode.innerHTML = "";
        setCandidateMeta("Sign in to load candidates.");
      }
    }

    function normalizeCandidatePayload(payload) {
      if (Array.isArray(payload)) {
        return {
          items: payload,
          paging: {
            offset: candidateOffset,
            nextOffset: candidateOffset + payload.length,
            total: candidateOffset + payload.length,
            hasMore: payload.length === CANDIDATE_PAGE_SIZE
          }
        };
      }

      const items = Array.isArray(payload && payload.items) ? payload.items : [];
      const paging = payload && payload.paging ? payload.paging : {};
      return {
        items,
        paging: {
          offset: Number(paging.offset || 0),
          nextOffset: Number(paging.nextOffset || items.length),
          total: Number(paging.total || items.length),
          hasMore: Boolean(paging.hasMore)
        }
      };
    }

    function createCandidateItem(entry) {
      const item = document.createElement("article");
      item.className = "candidate-item";

      const name = document.createElement("strong");
      name.textContent = entry && entry.name ? String(entry.name) : "Unnamed candidate";

      const link = document.createElement("a");
      const url = entry && entry.url ? String(entry.url) : "";
      link.href = url || "#";
      link.textContent = url || "-";
      link.target = "_blank";
      link.rel = "noopener noreferrer";

      const summary = document.createElement("span");
      const status = entry && entry.status ? String(entry.status) : "-";
      const discoveredCount = Number(entry && entry.discoveredCount ? entry.discoveredCount : 0);
      summary.textContent = `status: ${status} | discovered: ${discoveredCount}`;

      const abilities = document.createElement("span");
      const abilityList = Array.isArray(entry && entry.abilities) ? entry.abilities.join(", ") : "";
      const tagList = Array.isArray(entry && entry.tags) ? entry.tags.join(", ") : "";
      abilities.textContent = `abilities: ${abilityList || "-"} | tags: ${tagList || "-"} | pricing: ${entry && entry.pricing ? String(entry.pricing) : "trial"}`;

      const updated = document.createElement("span");
      updated.textContent = `updated: ${formatDate(entry && entry.updatedAt)}`;

      item.append(name, link, summary, abilities, updated);
      return item;
    }

    async function fetchJson(url, options) {
      const response = await fetch(url, options || {});
      const payload = await response.json().catch(() => ({}));
      return { response, payload };
    }

    async function handleUnauthorized() {
      setAuthState(false, null);
      setStatus("Session expired. Please sign in again.", "error");
      setAuthStatus("Session expired. Sign in again.", "error");
    }

    async function loadCandidatePage(options = {}) {
      const reset = Boolean(options.reset);
      if (!state.authenticated) {
        setCandidateMeta("Sign in to load candidates.");
        return;
      }
      if (candidateLoading) return;

      if (reset) {
        candidateOffset = 0;
        candidateHasMore = true;
        candidateListNode.innerHTML = "";
      }
      if (!candidateHasMore) return;

      candidateLoading = true;
      setCandidateMeta("Loading candidates...");
      try {
        const { response, payload } = await fetchJson(`/api/candidate-link-list?offset=${candidateOffset}&limit=${CANDIDATE_PAGE_SIZE}`, {
          method: "GET"
        });

        if (response.status === 401) {
          await handleUnauthorized();
          return;
        }

        if (!response.ok) {
          throw new Error(payload && payload.error ? String(payload.error) : `HTTP ${response.status}`);
        }

        const normalized = normalizeCandidatePayload(payload);
        if (!normalized.items.length && candidateOffset === 0) {
          setCandidateMeta("No candidates found.");
        }

        normalized.items.forEach((entry) => {
          candidateListNode.appendChild(createCandidateItem(entry));
        });

        candidateOffset = normalized.paging.nextOffset;
        candidateHasMore = normalized.paging.hasMore;
        setCandidateMeta(
          `Loaded ${candidateOffset} of ${normalized.paging.total} candidates${candidateHasMore ? " (scroll for more)" : ""}.`
        );
      } catch (error) {
        setCandidateMeta(`Candidate list error: ${error instanceof Error ? error.message : "unknown error"}`);
      } finally {
        candidateLoading = false;
      }
    }

    async function runUpdateList() {
      if (!state.authenticated) {
        setStatus("Sign in first.", "error");
        return;
      }

      const confirmed = window.confirm("Confirm update-list? This will merge current pending candidates into main list.");
      if (!confirmed) return;

      try {
        updateButton.disabled = true;
        updateTierButton.disabled = true;
        setStatus("Updating list...", "");

        const { response, payload } = await fetchJson("/api/admin-update-list", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: "{}"
        });

        if (response.status === 401) {
          await handleUnauthorized();
          return;
        }

        if (!response.ok) {
          throw new Error(payload && payload.error ? String(payload.error) : `HTTP ${response.status}`);
        }

        setStatus(
          [
            "Update completed.",
            `Backup: ${payload.backupFileName || "n/a"}`,
            `Pending scanned: ${payload.pendingCount || 0}`,
            `Merged: ${payload.mergedCount || 0}`,
            `Skipped existing: ${payload.skippedExistingCount || 0}`,
            `Total links now: ${payload.totalLinks || 0}`
          ].join("\n"),
          "ok"
        );
        await loadCandidatePage({ reset: true });
      } catch (error) {
        setStatus(`Update failed: ${error instanceof Error ? error.message : "unknown error"}`, "error");
      } finally {
        updateButton.disabled = false;
        updateTierButton.disabled = false;
      }
    }

    async function runUpdateTier() {
      if (!state.authenticated) {
        setStatus("Sign in first.", "error");
        return;
      }

      const confirmed = window.confirm("Confirm update-tier? This will normalize pricing/tags values in the main database.");
      if (!confirmed) return;

      try {
        updateButton.disabled = true;
        updateTierButton.disabled = true;
        setStatus("Updating tiers...", "");

        const { response, payload } = await fetchJson("/api/admin-update-tier", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: "{}"
        });

        if (response.status === 401) {
          await handleUnauthorized();
          return;
        }

        if (!response.ok) {
          throw new Error(payload && payload.error ? String(payload.error) : `HTTP ${response.status}`);
        }

        setStatus(
          [
            "Tier update completed.",
            `Scanned links: ${payload.scannedCount || 0}`,
            `Rows normalized: ${payload.updatedCount || 0}`,
            `Total links now: ${payload.totalLinks || 0}`
          ].join("\n"),
          "ok"
        );
        await loadCandidatePage({ reset: true });
      } catch (error) {
        setStatus(`Tier update failed: ${error instanceof Error ? error.message : "unknown error"}`, "error");
      } finally {
        updateButton.disabled = false;
        updateTierButton.disabled = false;
      }
    }

    function loadGoogleScript() {
      if (window.google && window.google.accounts && window.google.accounts.id) {
        return Promise.resolve();
      }

      return new Promise((resolve, reject) => {
        const existing = document.querySelector("script[data-google-gsi='1']");
        if (existing) {
          existing.addEventListener("load", () => resolve(), { once: true });
          existing.addEventListener("error", () => reject(new Error("google_script_failed")), { once: true });
          return;
        }

        const script = document.createElement("script");
        script.src = "https://accounts.google.com/gsi/client";
        script.async = true;
        script.defer = true;
        script.dataset.googleGsi = "1";
        script.onload = () => resolve();
        script.onerror = () => reject(new Error("google_script_failed"));
        document.head.appendChild(script);
      });
    }

    async function loadAuthConfig() {
      const { response, payload } = await fetchJson("/api/admin-auth-config", { method: "GET" });
      if (!response.ok) {
        throw new Error(payload && payload.error ? String(payload.error) : `HTTP ${response.status}`);
      }
      if (!payload || !payload.enabled || !payload.googleClientId) {
        throw new Error("Google admin auth is not configured in environment variables.");
      }
      state.googleClientId = String(payload.googleClientId);
    }

    async function onGoogleCredentialResponse(response) {
      const credential = String(response && response.credential ? response.credential : "").trim();
      if (!credential) {
        setAuthStatus("Missing Google credential.", "error");
        return;
      }

      setAuthStatus("Signing in...", "");
      try {
        const { response: loginResponse, payload } = await fetchJson("/api/admin-login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ credential })
        });

        if (!loginResponse.ok) {
          throw new Error(payload && payload.error ? String(payload.error) : `HTTP ${loginResponse.status}`);
        }

        setAuthState(true, payload && payload.user ? payload.user : null);
        setAuthStatus("Signed in.", "ok");
        setStatus("", "");
        await loadCandidatePage({ reset: true });
      } catch (error) {
        setAuthState(false, null);
        setAuthStatus(`Sign in failed: ${error instanceof Error ? error.message : "unknown error"}`, "error");
      }
    }

    function renderGoogleSignInButton() {
      if (!(window.google && window.google.accounts && window.google.accounts.id)) {
        throw new Error("Google Sign-In script not available.");
      }

      window.google.accounts.id.initialize({
        client_id: state.googleClientId,
        callback: onGoogleCredentialResponse,
        auto_select: false,
        cancel_on_tap_outside: true,
        ux_mode: "popup"
      });

      signInButtonHost.innerHTML = "";
      window.google.accounts.id.renderButton(signInButtonHost, {
        type: "standard",
        theme: "outline",
        size: "large",
        text: "signin_with",
        shape: "rectangular",
        width: 280
      });
      state.googleReady = true;
    }

    async function restoreSession() {
      try {
        const { response, payload } = await fetchJson("/api/admin-session", { method: "GET" });
        if (!response.ok) {
          setAuthState(false, null);
          return;
        }

        setAuthState(true, payload && payload.user ? payload.user : null);
        setAuthStatus("Session restored.", "ok");
        await loadCandidatePage({ reset: true });
      } catch {
        setAuthState(false, null);
      }
    }

    async function logout() {
      try {
        await fetchJson("/api/admin-logout", { method: "POST" });
      } catch {}

      if (state.googleReady && window.google && window.google.accounts && window.google.accounts.id) {
        window.google.accounts.id.disableAutoSelect();
      }

      setAuthState(false, null);
      setStatus("Signed out.", "");
      setAuthStatus("Signed out.", "");
    }

    candidateListNode.addEventListener("scroll", () => {
      if (!state.authenticated) return;
      const remaining = candidateListNode.scrollHeight - candidateListNode.scrollTop - candidateListNode.clientHeight;
      if (remaining <= CANDIDATE_SCROLL_THRESHOLD_PX) {
        loadCandidatePage({ reset: false });
      }
    });

    updateButton.addEventListener("click", runUpdateList);
    updateTierButton.addEventListener("click", runUpdateTier);
    logoutButton.addEventListener("click", logout);

    async function init() {
      setAuthState(false, null);
      setStatus("", "");
      setAuthStatus("Checking admin auth configuration...", "");
      try {
        await loadAuthConfig();
        await loadGoogleScript();
        renderGoogleSignInButton();
        setAuthStatus("Use Google Sign-In with an approved admin account.", "");
      } catch (error) {
        setAuthStatus(`Authentication setup error: ${error instanceof Error ? error.message : "unknown error"}`, "error");
        return;
      }

      await restoreSession();
    }

    init();
  </script>
</body>
</html>
